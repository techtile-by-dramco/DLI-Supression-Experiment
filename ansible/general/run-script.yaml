# Part of the redesigned client management system
# Run a script on the client
---
- name: Run status script and check result
  hosts: all
  become: no
  vars:
    # Default script path
    default_script_path: "/home/pi/check_status.sh"
    # Use provided 'script_path' extra var if set, otherwise default
    script_path: "{{ script_path | default(default_script_path) }}"

  tasks:
    - name: Run the script
      ansible.builtin.command: "{{ script_path }}"
      register: script_output
      changed_when: false

    - name: Fail if result is not OK
      ansible.builtin.fail:
        msg: "The script reported: {{ script_output.stdout }}"
      when: script_output.stdout != "OK"

    - name: Success message if OK
      ansible.builtin.debug:
        msg: "The script returned OK"
      when: script_output.stdout == "OK"
